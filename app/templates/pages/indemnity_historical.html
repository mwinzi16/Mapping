{% extends "base.html" %}

{% block title %}Indemnity Historical Analysis â€” Catastrophe Analysis Platform{% endblock %}

{% block subnav %}
<!-- Indemnity Sub-navigation -->
<div class="bg-gray-800 border-b border-gray-700 px-6 py-2 flex-shrink-0">
    <nav class="flex items-center space-x-1" aria-label="Indemnity navigation">
        <a href="/indemnity/live"
           class="flex items-center space-x-2 px-4 py-2 rounded-lg transition-colors text-sm text-gray-300 hover:bg-gray-700 hover:text-white">
            <!-- Activity Icon -->
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M22 12h-2.48a2 2 0 0 0-1.93 1.46l-2.35 8.36a.25.25 0 0 1-.48 0L9.24 2.18a.25.25 0 0 0-.48 0l-2.35 8.36A2 2 0 0 1 4.49 12H2"></path>
            </svg>
            <span>Live Cat</span>
        </a>
        <a href="/indemnity/historical"
           class="flex items-center space-x-2 px-4 py-2 rounded-lg transition-colors text-sm bg-blue-600 text-white">
            <!-- BarChart3 Icon -->
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 3v18h18"></path>
                <path d="M18 17V9"></path>
                <path d="M13 17V5"></path>
                <path d="M8 17v-3"></path>
            </svg>
            <span>Historical</span>
        </a>
    </nav>
</div>
{% endblock %}

{% block content %}
<div class="flex-1 flex overflow-hidden bg-gray-900">
    <!-- Left Panel -->
    <aside class="w-80 bg-gray-800 border-r border-gray-700 flex flex-col overflow-hidden">
        <!-- Header -->
        <div class="p-4 border-b border-gray-700">
            <div class="flex items-center gap-2 mb-2">
                <!-- BarChart3 Icon -->
                <svg class="w-5 h-5 text-blue-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M3 3v18h18"></path>
                    <path d="M18 17V9"></path>
                    <path d="M13 17V5"></path>
                    <path d="M8 17v-3"></path>
                </svg>
                <h2 class="text-lg font-bold text-white">Historical Analysis</h2>
            </div>
            <p class="text-xs text-gray-400">TIV exposure overlay with historical catastrophe events</p>
        </div>

        <!-- Scrollable Content -->
        <div class="flex-1 overflow-y-auto">
            <!-- Load Historical Events -->
            <div class="border-b border-gray-700">
                <button onclick="toggleSection('hist-load-content')" class="w-full flex items-center justify-between p-4 hover:bg-gray-700/50 transition-colors">
                    <div class="flex items-center gap-2">
                        <!-- Database Icon -->
                        <svg class="w-4 h-4 text-blue-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <ellipse cx="12" cy="5" rx="9" ry="3"></ellipse>
                            <path d="M3 5V19A9 3 0 0 0 21 19V5"></path>
                            <path d="M3 12A9 3 0 0 0 21 12"></path>
                        </svg>
                        <span class="text-sm font-medium text-white">Load Events</span>
                    </div>
                    <svg class="w-4 h-4 text-gray-400 section-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="m6 9 6 6 6-6"></path>
                    </svg>
                </button>
                <div id="hist-load-content" class="px-4 pb-4 space-y-3">
                    <div>
                        <label class="block text-xs text-gray-400 mb-2">Load Mode</label>
                        <div class="grid grid-cols-4 gap-1">
                            <button onclick="setHistLoadMode('top10')" class="hist-mode-btn px-2 py-1.5 bg-gray-700 hover:bg-gray-600 text-gray-300 text-xs rounded transition-colors" data-mode="top10">Top 10</button>
                            <button onclick="setHistLoadMode('top20')" class="hist-mode-btn px-2 py-1.5 bg-gray-700 hover:bg-gray-600 text-gray-300 text-xs rounded transition-colors" data-mode="top20">Top 20</button>
                            <button onclick="setHistLoadMode('top30')" class="hist-mode-btn px-2 py-1.5 bg-blue-600 text-white text-xs rounded transition-colors" data-mode="top30">Top 30</button>
                            <button onclick="setHistLoadMode('all')" class="hist-mode-btn px-2 py-1.5 bg-gray-700 hover:bg-gray-600 text-gray-300 text-xs rounded transition-colors" data-mode="all">All</button>
                        </div>
                    </div>
                    <button onclick="loadHistoricalEvents()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-lg text-sm font-medium transition-colors flex items-center justify-center gap-2">
                        <svg id="hist-load-spinner" class="w-4 h-4 animate-spin hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>
                        <span>Load Historical Events</span>
                    </button>
                    <div id="hist-load-error" class="text-xs text-red-400 hidden"></div>
                </div>
            </div>

            <!-- Event Search & Filter -->
            <div class="border-b border-gray-700">
                <button onclick="toggleSection('hist-search-content')" class="w-full flex items-center justify-between p-4 hover:bg-gray-700/50 transition-colors">
                    <div class="flex items-center gap-2">
                        <!-- Search Icon -->
                        <svg class="w-4 h-4 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.3-4.3"></path>
                        </svg>
                        <span class="text-sm font-medium text-white">Search & Filter</span>
                    </div>
                    <svg class="w-4 h-4 text-gray-400 section-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="m6 9 6 6 6-6"></path>
                    </svg>
                </button>
                <div id="hist-search-content" class="px-4 pb-4 space-y-3">
                    <div class="relative">
                        <svg class="absolute left-2 top-1/2 -translate-y-1/2 w-4 h-4 text-gray-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.3-4.3"></path>
                        </svg>
                        <input type="text" id="hist-search-input" placeholder="Search events..."
                               class="w-full bg-gray-700 text-white rounded pl-8 pr-2 py-1.5 text-sm border border-gray-600 focus:border-blue-500 focus:outline-none"
                               oninput="filterHistoricalEvents()">
                    </div>
                    <div class="flex gap-1">
                        <button onclick="setHistTypeFilter('all')" class="hist-type-btn flex-1 px-2 py-1.5 bg-blue-600 text-white text-xs rounded transition-colors" data-type="all">All</button>
                        <button onclick="setHistTypeFilter('earthquake')" class="hist-type-btn flex-1 px-2 py-1.5 bg-gray-700 hover:bg-gray-600 text-gray-300 text-xs rounded transition-colors" data-type="earthquake">EQ</button>
                        <button onclick="setHistTypeFilter('hurricane')" class="hist-type-btn flex-1 px-2 py-1.5 bg-gray-700 hover:bg-gray-600 text-gray-300 text-xs rounded transition-colors" data-type="hurricane">TC</button>
                    </div>
                </div>
            </div>

            <!-- Event List -->
            <div class="border-b border-gray-700">
                <button onclick="toggleSection('hist-events-content')" class="w-full flex items-center justify-between p-4 hover:bg-gray-700/50 transition-colors">
                    <div class="flex items-center gap-2">
                        <!-- Calendar Icon -->
                        <svg class="w-4 h-4 text-blue-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M8 2v4"></path>
                            <path d="M16 2v4"></path>
                            <rect width="18" height="18" x="3" y="4" rx="2"></rect>
                            <path d="M3 10h18"></path>
                        </svg>
                        <span class="text-sm font-medium text-white">Events</span>
                        <span class="text-xs text-gray-400 ml-1" id="hist-event-count">(0)</span>
                    </div>
                    <svg class="w-4 h-4 text-gray-400 section-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="m6 9 6 6 6-6"></path>
                    </svg>
                </button>
                <div id="hist-events-content" class="max-h-64 overflow-y-auto">
                    <ul id="hist-event-list" class="divide-y divide-gray-700">
                        <li class="p-4 text-center text-gray-500 text-sm">Click "Load Historical Events" to get started</li>
                    </ul>
                </div>
            </div>

            <!-- Layer Toggles -->
            <div class="border-b border-gray-700">
                <button onclick="toggleSection('hist-layers-content')" class="w-full flex items-center justify-between p-4 hover:bg-gray-700/50 transition-colors">
                    <div class="flex items-center gap-2">
                        <svg class="w-4 h-4 text-blue-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path>
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                        <span class="text-sm font-medium text-white">Layers</span>
                    </div>
                    <svg class="w-4 h-4 text-gray-400 section-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="m6 9 6 6 6-6"></path>
                    </svg>
                </button>
                <div id="hist-layers-content" class="px-4 pb-4 space-y-2 hidden">
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="checkbox" id="hist-toggle-tiv" checked class="w-4 h-4 rounded bg-gray-700 border-gray-600 text-purple-500 focus:ring-purple-500" onchange="toggleHistLayer('tiv')">
                        <span class="text-sm text-white">TIV Locations</span>
                    </label>
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="checkbox" id="hist-toggle-events" checked class="w-4 h-4 rounded bg-gray-700 border-gray-600 text-blue-500 focus:ring-blue-500" onchange="toggleHistLayer('events')">
                        <span class="text-sm text-white">Historical Events</span>
                    </label>
                </div>
            </div>

            <!-- TIV Data Upload -->
            <div class="border-b border-gray-700">
                <button onclick="toggleSection('hist-tiv-content')" class="w-full flex items-center justify-between p-4 hover:bg-gray-700/50 transition-colors">
                    <div class="flex items-center gap-2">
                        <svg class="w-4 h-4 text-green-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        <span class="text-sm font-medium text-white">TIV Data</span>
                    </div>
                    <svg class="w-4 h-4 text-gray-400 section-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="m6 9 6 6 6-6"></path>
                    </svg>
                </button>
                <div id="hist-tiv-content" class="px-4 pb-4 space-y-3 hidden">
                    <div id="hist-tiv-dropzone" class="border-2 border-dashed border-gray-600 rounded-lg p-6 text-center cursor-pointer hover:border-green-500 transition-colors"
                         ondragover="event.preventDefault(); this.classList.add('border-green-500', 'bg-green-900/10')"
                         ondragleave="this.classList.remove('border-green-500', 'bg-green-900/10')"
                         ondrop="handleHistTIVDrop(event)"
                         onclick="document.getElementById('hist-tiv-file-input').click()">
                        <svg class="w-8 h-8 text-gray-500 mx-auto mb-2" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="17 8 12 3 7 8"></polyline>
                            <line x1="12" y1="3" x2="12" y2="15"></line>
                        </svg>
                        <p class="text-sm text-gray-400">Drop CSV file here or click to browse</p>
                        <p class="text-xs text-gray-500 mt-1">Expected columns: name, lat, lon, tiv</p>
                    </div>
                    <input type="file" id="hist-tiv-file-input" accept=".csv,.xlsx" class="hidden" onchange="handleHistTIVFileSelect(event)">
                    <div id="hist-tiv-data-summary" class="hidden">
                        <div class="flex items-center justify-between bg-gray-700/50 rounded-lg p-3">
                            <div>
                                <p class="text-sm font-medium text-white" id="hist-tiv-file-name">data.csv</p>
                                <p class="text-xs text-gray-400"><span id="hist-tiv-record-count">0</span> locations loaded</p>
                            </div>
                            <button onclick="clearHistTIVData()" class="text-red-400 hover:text-red-300 p-1">
                                <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <path d="M18 6 6 18"></path><path d="m6 6 12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistics -->
            <div class="border-b border-gray-700">
                <button onclick="toggleSection('hist-stats-content')" class="w-full flex items-center justify-between p-4 hover:bg-gray-700/50 transition-colors">
                    <div class="flex items-center gap-2">
                        <svg class="w-4 h-4 text-purple-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M3 3v18h18"></path>
                            <path d="M18 17V9"></path>
                            <path d="M13 17V5"></path>
                            <path d="M8 17v-3"></path>
                        </svg>
                        <span class="text-sm font-medium text-white">Statistics</span>
                    </div>
                    <svg class="w-4 h-4 text-gray-400 section-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="m6 9 6 6 6-6"></path>
                    </svg>
                </button>
                <div id="hist-stats-content" class="px-4 pb-4 hidden">
                    <div id="hist-statistics" class="space-y-2">
                        <p class="text-xs text-gray-500 text-center py-4">Load events and TIV data to see impact analysis</p>
                    </div>
                </div>
            </div>
        </div>
    </aside>

    <!-- Map Area -->
    <main class="flex-1 relative">
        <!-- Map Container -->
        <div id="indemnity-hist-map" class="w-full h-full"></div>

        <!-- Impact Analysis Badge -->
        <div id="hist-impact-badge" class="absolute top-4 right-4 z-10 bg-gray-800/95 backdrop-blur-sm rounded-lg border border-gray-700 p-3 hidden">
            <div class="flex items-center gap-2 mb-1">
                <!-- AlertTriangle Icon -->
                <svg class="w-4 h-4 text-yellow-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path>
                    <path d="M12 9v4"></path>
                    <path d="M12 17h.01"></path>
                </svg>
                <span class="text-sm font-medium text-white">Impact Summary</span>
            </div>
            <div class="space-y-1 text-xs">
                <div class="flex justify-between">
                    <span class="text-gray-400">Selected Events:</span>
                    <span class="text-white font-medium" id="impact-event-count">0</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Affected TIV:</span>
                    <span class="text-white font-medium" id="impact-tiv-value">$0</span>
                </div>
                <div class="flex justify-between">
                    <span class="text-gray-400">Locations at Risk:</span>
                    <span class="text-white font-medium" id="impact-location-count">0</span>
                </div>
            </div>
        </div>

        <!-- Legend Overlay -->
        <div id="hist-legend" class="absolute bottom-8 left-4 z-10 bg-gray-800/95 backdrop-blur-sm rounded-lg border border-gray-700 p-3 hidden">
            <h4 class="text-xs font-medium text-white mb-2">Legend</h4>
            <div class="space-y-1">
                <div class="flex items-center gap-2">
                    <span class="w-3 h-3 rounded-full bg-purple-500"></span>
                    <span class="text-xs text-gray-300">TIV Locations</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="w-3 h-3 rounded-full bg-yellow-500"></span>
                    <span class="text-xs text-gray-300">Earthquakes</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="w-3 h-3 rounded-full bg-blue-500"></span>
                    <span class="text-xs text-gray-300">Hurricanes</span>
                </div>
                <div class="space-y-0.5 ml-5">
                    <div class="flex items-center gap-2"><span class="w-6 h-0.5 bg-green-500"></span><span class="text-xs text-gray-400">Cat 1</span></div>
                    <div class="flex items-center gap-2"><span class="w-6 h-0.5 bg-yellow-500"></span><span class="text-xs text-gray-400">Cat 2</span></div>
                    <div class="flex items-center gap-2"><span class="w-6 h-0.5 bg-orange-500"></span><span class="text-xs text-gray-400">Cat 3</span></div>
                    <div class="flex items-center gap-2"><span class="w-6 h-0.5 bg-red-500"></span><span class="text-xs text-gray-400">Cat 4</span></div>
                    <div class="flex items-center gap-2"><span class="w-6 h-0.5 bg-purple-600"></span><span class="text-xs text-gray-400">Cat 5</span></div>
                </div>
            </div>
        </div>

        <!-- Loading Overlay -->
        <div id="indemnity-hist-loading" class="absolute inset-0 z-10 bg-gray-900/50 flex items-center justify-center hidden">
            <div class="flex items-center space-x-3 bg-gray-800 px-6 py-4 rounded-lg">
                <svg class="w-6 h-6 text-blue-400 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>
                <span class="text-white">Loading historical data...</span>
            </div>
        </div>
    </main>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/map.js') }}"></script>
<script src="{{ url_for('static', filename='js/indemnity.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    initIndemnityHistoricalPage();
});
</script>
{% endblock %}